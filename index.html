<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Avaliação de Cultura de Segurança EHS — Executivo</title>

<!-- Tailwind CDN (ok para protótipo). Em produção, gerar build com purge. -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* Toasts leves e acessíveis */
  .toast {
    pointer-events: none;
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    max-width: 420px;
    z-index: 9999;
  }
  .toast-item {
    pointer-events: auto;
    transition: transform .25s ease, opacity .25s ease;
  }
  .toast-enter {
    opacity: 0; transform: translateY(10px);
  }
  .toast-enter-active {
    opacity: 1; transform: translateY(0);
  }

  /* Foco visível para acessibilidade */
  .focus-ring:focus {
    outline: 3px solid #60a5fa; /* azul-400 */
    outline-offset: 2px;
  }

  /* Botões de resposta (estado visual consistente) */
  .ans-default { @apply border border-slate-300 text-slate-700 bg-white; }
  .ans-yes     { @apply bg-green-600 text-white border-green-600; }
  .ans-partial { @apply bg-amber-500 text-white border-amber-500; }
  .ans-no      { @apply bg-rose-600 text-white border-rose-600; }
  .ans-na      { @apply bg-slate-400 text-white border-slate-400; }

  /* Tabela responsiva básica */
  .table-wrap { overflow-x: auto; }
</style>
</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-slate-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-2xl font-semibold">Avaliação de Cultura de Segurança EHS</h1>
      <p class="opacity-80">Comparável entre sites, pronta para diretoria</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Configuração inicial -->
    <section class="bg-white rounded-xl shadow p-4 space-y-4">
      <h2 class="text-xl font-semibold">1) Identificação</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1" for="company">Empresa / Projeto</label>
          <input id="company" type="text" class="focus-ring w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Ex.: Projeto VLT — Instalação" aria-describedby="companyHelp" />
          <p id="companyHelp" class="text-xs text-slate-500 mt-1">Obrigatório</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1" for="unit">Unidade / Site (opcional)</label>
          <input id="unit" type="text" class="focus-ring w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Ex.: Pátio A / Linha 2" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1" for="assessor">Avaliador (opcional)</label>
          <input id="assessor" type="text" class="focus-ring w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Ex.: Eng. Leandro" />
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <button id="startBradley" class="focus-ring rounded-lg px-4 py-2 bg-slate-300 text-slate-600 cursor-not-allowed" disabled aria-disabled="true">
          Iniciar — Bradley Curve
        </button>
        <button id="startHM" class="focus-ring rounded-lg px-4 py-2 bg-slate-300 text-slate-600 cursor-not-allowed" disabled aria-disabled="true">
          Iniciar — Hearts & Minds
        </button>
      </div>
      <p class="text-xs text-slate-500">Os botões são habilitados ao preencher “Empresa / Projeto”.</p>
    </section>

    <!-- Container das avaliações -->
    <section id="assessmentContainer" class="bg-white rounded-xl shadow p-4 hidden space-y-4" aria-live="polite" aria-atomic="true">
      <div class="flex items-center justify-between gap-4">
        <h2 id="assessmentTitle" class="text-xl font-semibold">Avaliação</h2>
        <div class="text-sm text-slate-600">
          Progresso: <span id="progressCount">0</span>/<span id="progressTotal">0</span> | Válidas: <span id="validCount">0</span>
        </div>
      </div>

      <!-- Perguntas -->
      <div id="questionsList" class="grid gap-3"></div>

      <!-- Ações -->
      <div class="flex flex-wrap items-center gap-3 pt-2">
        <button id="finishBtn" class="focus-ring rounded-lg px-4 py-2 bg-blue-600 text-white">
          Finalizar Avaliação
        </button>
        <button id="cancelBtn" class="focus-ring rounded-lg px-4 py-2 bg-slate-200 text-slate-800">
          Cancelar
        </button>
      </div>
    </section>

    <!-- Resultados -->
    <section class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">2) Histórico & Relatórios</h2>
        <div class="flex flex-wrap items-center gap-2">
          <button id="exportCsvBtn" class="focus-ring rounded-lg px-3 py-2 bg-emerald-600 text-white">Exportar CSV</button>
          <button id="clearAllBtn" class="focus-ring rounded-lg px-3 py-2 bg-rose-600 text-white">Limpar Histórico</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="text-left px-3 py-2">Data</th>
              <th class="text-left px-3 py-2">Empresa</th>
              <th class="text-left px-3 py-2">Unidade</th>
              <th class="text-left px-3 py-2">Metodologia</th>
              <th class="text-left px-3 py-2">Índice</th>
              <th class="text-left px-3 py-2">Nível</th>
              <th class="text-left px-3 py-2">Ações</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500">Ordenado por <code>timestamp</code> ISO (mais recente primeiro).</p>
    </section>

    <!-- Bradley Curve (inline SVG, local) -->
    <section class="bg-white rounded-xl shadow p-4 space-y-2">
      <h2 class="text-xl font-semibold">3) Referência — Bradley Curve (visual)</h2>
      <p class="text-sm text-slate-600">Curva de maturidade comportamental. Útil como analogia rápida para diretoria.</p>
      <div class="overflow-x-auto">
        <svg viewBox="0 0 940 260" role="img" aria-label="Bradley Curve" class="w-[900px] h-auto mx-auto">
          <!-- Eixos e faixas simplificadas -->
          <defs>
            <linearGradient id="grad" x1="0" x2="1" y1="0" y2="0">
              <stop offset="0%" stop-color="#ef4444"/>
              <stop offset="50%" stop-color="#f59e0b"/>
              <stop offset="100%" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <rect x="20" y="20" width="900" height="200" fill="url(#grad)" opacity="0.08" />
          <text x="60" y="230" font-size="12" fill="#475569">Reactive</text>
          <text x="300" y="230" font-size="12" fill="#475569">Dependent</text>
          <text x="540" y="230" font-size="12" fill="#475569">Independent</text>
          <text x="780" y="230" font-size="12" fill="#475569">Interdependent</text>
          <path d="M 40 190 C 220 200, 360 160, 520 120 S 820 60, 900 40" stroke="#0ea5e9" stroke-width="3" fill="none"/>
        </svg>
      </div>
    </section>
  </main>

  <!-- Toast container -->
  <div id="toast" class="toast space-y-2"></div>

<script>
/* ===============================
   Schema, Storage & Utilitários
   =============================== */
const SCHEMA_VERSION = 2; // incrementado p/ timestamp ISO + campos separados
const STORAGE_KEY = 'ehsAssessments_v2';

function nowISO() { return new Date().toISOString(); }

function loadAll() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { version: SCHEMA_VERSION, items: [] };
    const data = JSON.parse(raw);
    // Migração básica se versão antiga
    if (!data.version) {
      return { version: SCHEMA_VERSION, items: [] };
    }
    if (!Array.isArray(data.items)) data.items = [];
    return data;
  } catch (e) {
    console.error('Erro ao ler storage:', e);
    toast('Não foi possível ler o histórico salvo. Um novo histórico será iniciado.', 'warn');
    return { version: SCHEMA_VERSION, items: [] };
  }
}

function saveAll(data) {
  try {
    const payload = JSON.stringify({ version: SCHEMA_VERSION, items: data.items || [] });
    localStorage.setItem(STORAGE_KEY, payload);
  } catch (e) {
    console.error('Erro ao salvar storage:', e);
    toast('Falha ao salvar dados localmente. Verifique espaço e permissões.', 'error');
  }
}

function addRecord(record) {
  const db = loadAll();
  db.items.unshift(record); // mais recente no topo
  saveAll(db);
}

function clearAll() {
  localStorage.removeItem(STORAGE_KEY);
}

/* ==============
   Toast simples
   ============== */
function toast(message, type='info') {
  const container = document.getElementById('toast');
  const el = document.createElement('div');
  const base = 'toast-item rounded-lg px-4 py-3 shadow text-sm border';
  const palette = {
    info:  'bg-white text-slate-800 border-slate-200',
    ok:    'bg-emerald-50 text-emerald-900 border-emerald-200',
    warn:  'bg-amber-50 text-amber-900 border-amber-200',
    error: 'bg-rose-50 text-rose-900 border-rose-200'
  };
  el.className = `${base} ${palette[type] || palette.info} toast-enter`;
  el.innerHTML = `<div class="font-medium">${message}</div>`;
  container.appendChild(el);
  // animação
  requestAnimationFrame(()=> el.classList.add('toast-enter-active'));
  // remover
  setTimeout(()=> {
    el.classList.remove('toast-enter-active');
    setTimeout(()=> el.remove(), 250);
  }, 3500);
}

/* ==========================
   Banco de Perguntas (demo)
   ========================== */
/* Bradley: 10 itens simples (sim/parcial/não/na).
   Hearts & Minds: 12 itens com estágio para inversão coerente. */

const QUESTIONS = {
  bradley: [
    { id:'b1', text:'Regras são seguidas de forma consistente.', dim:'Compliance' },
    { id:'b2', text:'Supervisores reforçam comportamentos seguros diariamente.', dim:'Leadership' },
    { id:'b3', text:'Trabalhadores param a tarefa quando percebem risco.', dim:'Empowerment' },
    { id:'b4', text:'Lições aprendidas são compartilhadas rapidamente.', dim:'Learning' },
    { id:'b5', text:'Planejamento de risco é feito antes de atividades críticas.', dim:'Planning' },
    { id:'b6', text:'Investigamos quase-acidentes com qualidade.', dim:'Learning' },
    { id:'b7', text:'Comunicação sobre riscos é clara e frequente.', dim:'Communication' },
    { id:'b8', text:'Manutenções são realizadas antes da falha.', dim:'Reliability' },
    { id:'b9', text:'Indicadores proativos são acompanhados por líderes.', dim:'Performance' },
    { id:'b10',text:'Terceiros seguem o mesmo padrão da casa.', dim:'Contractor' },
  ],
  heartsMinds: [
    // Itens regressivos (devem ser invertidos: yes=0 / partial=50 / no=100)
    { id:'hm1',  text:'As pessoas veem regras como obstáculo para produzir.', stage:'Reactive', dim:'Attitude', regressive:true },
    { id:'hm2',  text:'Investigações focam principalmente em “quem errou”.', stage:'Reactive', dim:'Learning', regressive:true },
    { id:'hm3',  text:'Liderança enfatiza metas de produção sobre segurança.', stage:'Calculative', dim:'Leadership', regressive:true },
    { id:'hm4',  text:'Indicadores reativos dominam a conversa (acidentes).', stage:'Calculative', dim:'Performance', regressive:true },
    // Itens progressivos (escala direta: yes=100 / partial=50 / no=0)
    { id:'hm5',  text:'As pessoas se sentem empoderadas para parar o trabalho.', stage:'Proactive', dim:'Empowerment', regressive:false },
    { id:'hm6',  text:'Feedbacks positivos sobre segurança são frequentes.', stage:'Proactive', dim:'Leadership', regressive:false },
    { id:'hm7',  text:'Aprendemos com o que dá certo (Safety-II).', stage:'Proactive', dim:'Learning', regressive:false },
    { id:'hm8',  text:'Treinamentos são práticos e baseados em risco real.', stage:'Proactive', dim:'Capability', regressive:false },
    { id:'hm9',  text:'Times planejam juntos as barreiras preventivas.', stage:'Generative', dim:'Planning', regressive:false },
    { id:'hm10', text:'Terceiros cocriam soluções e padrões conosco.', stage:'Generative', dim:'Contractor', regressive:false },
    { id:'hm11', text:'Indicadores proativos guiam decisões estratégicas.', stage:'Generative', dim:'Performance', regressive:false },
    { id:'hm12', text:'Compartilhamos lições com outras unidades/empresas.', stage:'Generative', dim:'Learning', regressive:false },
  ]
};

/* ===================================
   Estado de execução e renderização
   =================================== */
let current = null; // { methodology:'bradley'|'hm', answers: Map, startedAtISO, meta:{company,unit,assessor} }

const $ = (sel)=> document.querySelector(sel);
const elCompany   = $('#company');
const elUnit      = $('#unit');
const elAssessor  = $('#assessor');
const btnStartBrad= $('#startBradley');
const btnStartHM  = $('#startHM');
const assessmentContainer = $('#assessmentContainer');
const questionsList = $('#questionsList');
const finishBtn = $('#finishBtn');
const cancelBtn = $('#cancelBtn');
const progressCount = $('#progressCount');
const progressTotal = $('#progressTotal');
const validCount = $('#validCount');
const assessmentTitle = $('#assessmentTitle');
const historyBody = $('#historyBody');

function enableStartButtonsIfValid() {
  const hasCompany = elCompany.value.trim().length > 0;
  [btnStartBrad, btnStartHM].forEach(btn=>{
    btn.disabled = !hasCompany;
    btn.setAttribute('aria-disabled', String(!hasCompany));
    if (hasCompany) {
      btn.className = 'focus-ring rounded-lg px-4 py-2 bg-blue-600 text-white';
    } else {
      btn.className = 'focus-ring rounded-lg px-4 py-2 bg-slate-300 text-slate-600 cursor-not-allowed';
    }
  });
}

elCompany.addEventListener('input', enableStartButtonsIfValid);

/* Render de perguntas com delegação de eventos */
function renderAssessment(methodology) {
  current = {
    methodology,
    answers: new Map(), // id -> 'yes'|'partial'|'no'|'na'
    startedAtISO: nowISO(),
    meta: {
      company: elCompany.value.trim(),
      unit: elUnit.value.trim(),
      assessor: elAssessor.value.trim()
    }
  };

  const bank = (methodology==='bradley') ? QUESTIONS.bradley : QUESTIONS.heartsMinds;
  assessmentTitle.textContent = methodology==='bradley' ? 'Bradley Curve — Questionário' : 'Hearts & Minds — Questionário';
  questionsList.innerHTML = '';
  bank.forEach(q=>{
    const row = document.createElement('div');
    row.className = 'rounded-lg border border-slate-200 p-3 flex flex-col gap-2';
    row.setAttribute('data-id', q.id);

    row.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-medium">${q.text}</div>
          <div class="text-xs text-slate-500">Dimensão: ${q.dim}${q.stage ? ` · Estágio: ${q.stage}`:''}</div>
        </div>
        <div class="flex items-center gap-2">
          ${renderAnswerBtn(q.id,'yes','Sim')}
          ${renderAnswerBtn(q.id,'partial','Parcial')}
          ${renderAnswerBtn(q.id,'no','Não')}
          ${renderAnswerBtn(q.id,'na','N/A')}
        </div>
      </div>
    `;
    questionsList.appendChild(row);
  });

  progressTotal.textContent = bank.length;
  progressCount.textContent = '0';
  validCount.textContent = '0';

  assessmentContainer.classList.remove('hidden');
  window.scrollTo({ top: assessmentContainer.offsetTop - 20, behavior:'smooth' });
}

function renderAnswerBtn(qid, val, label) {
  const classes = 'ans-default focus-ring rounded-md px-3 py-1.5 border text-xs';
  const aria = `aria-pressed="false" aria-label="${label}"`;
  return `<button class="${classes}" data-qid="${qid}" data-val="${val}" ${aria}>${label}</button>`;
}

questionsList.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-qid]');
  if (!btn || !current) return;

  const qid = btn.getAttribute('data-qid');
  const val = btn.getAttribute('data-val');

  // zera estados visuais do grupo
  const group = btn.parentElement.querySelectorAll('button[data-qid="'+qid+'"]');
  group.forEach(b=>{
    b.classList.remove('ans-yes','ans-partial','ans-no','ans-na');
    b.classList.remove('text-white');
    b.setAttribute('aria-pressed', 'false');
    b.classList.add('ans-default');
  });

  // aplica estado do selecionado
  btn.classList.remove('ans-default');
  btn.setAttribute('aria-pressed', 'true');
  if (val==='yes') btn.classList.add('ans-yes');
  else if (val==='partial') btn.classList.add('ans-partial');
  else if (val==='no') btn.classList.add('ans-no');
  else btn.classList.add('ans-na');

  current.answers.set(qid, val);
  updateProgress();
});

function updateProgress() {
  const bank = (current.methodology==='bradley') ? QUESTIONS.bradley : QUESTIONS.heartsMinds;
  const answered = Array.from(current.answers.values()).filter(v=>!!v).length;
  const valids = Array.from(current.answers.values()).filter(v=>v!=='na').length;
  progressCount.textContent = answered.toString();
  validCount.textContent = valids.toString();
}

/* ==========================
   Scoring e Classificação
   ========================== */
function scoreBradley(answers) {
  // Escala direta: yes=100, partial=50, no=0, na=ignora
  const bank = QUESTIONS.bradley;
  let sum = 0, cnt = 0;
  const byDim = {};
  bank.forEach(q=>{
    const v = answers.get(q.id);
    if (!v || v==='na') return;
    const s = v==='yes' ? 100 : v==='partial' ? 50 : 0;
    sum += s; cnt++;
    byDim[q.dim] = byDim[q.dim] || { sum:0, n:0 };
    byDim[q.dim].sum += s; byDim[q.dim].n += 1;
  });
  const index = cnt ? +(sum/cnt).toFixed(1) : 0;

  // Nível aproximado pela média (faixas podem ser ajustadas)
  const level =
    index >= 85 ? 'Interdependent' :
    index >= 70 ? 'Independent' :
    index >= 55 ? 'Dependent' :
    'Reactive';

  const dims = Object.fromEntries(Object.entries(byDim).map(([k,v])=>[k, +(v.sum/v.n).toFixed(1)]));

  return { index, level, dims };
}

function scoreHeartsMinds(answers) {
  // Regressivos invertidos: yes=0, partial=50, no=100
  // Progressivos diretos:   yes=100, partial=50, no=0
  const bank = QUESTIONS.heartsMinds;

  const stageAgg = {}; // média por estágio
  const dimAgg = {};   // média por dimensão
  let sum = 0, cnt = 0;

  function scoreVal(v, regressive) {
    if (v==='na' || !v) return null;
    if (regressive) {
      return v==='yes' ? 0 : v==='partial' ? 50 : 100; // 'no' é positivo
    } else {
      return v==='yes' ? 100 : v==='partial' ? 50 : 0; // direto
    }
  }

  bank.forEach(q=>{
    const v = answers.get(q.id);
    const s = scoreVal(v, !!q.regressive);
    if (s==null) return;

    sum += s; cnt++;

    stageAgg[q.stage] = stageAgg[q.stage] || { sum:0, n:0 };
    stageAgg[q.stage].sum += s; stageAgg[q.stage].n += 1;

    dimAgg[q.dim] = dimAgg[q.dim] || { sum:0, n:0 };
    dimAgg[q.dim].sum += s; dimAgg[q.dim].n += 1;
  });

  const index = cnt ? +(sum/cnt).toFixed(1) : 0;

  // Nível dominante: maior média entre estágios
  const stageAverages = Object.fromEntries(
    Object.entries(stageAgg).map(([k,v])=>[k, +(v.sum/v.n).toFixed(1)])
  );

  let dominantStage = 'Reactive';
  let best = -1;
  for (const [st, val] of Object.entries(stageAverages)) {
    if (val > best) { best = val; dominantStage = st; }
  }

  const dims = Object.fromEntries(Object.entries(dimAgg).map(([k,v])=>[k, +(v.sum/v.n).toFixed(1)]));

  return { index, level: dominantStage, stages: stageAverages, dims };
}

/* ==========================
   Finalização e Histórico
   ========================== */
finishBtn.addEventListener('click', ()=>{
  if (!current) return;
  const company = current.meta.company;
  if (!company) { toast('Informe a Empresa/Projeto para salvar.', 'warn'); return; }

  let result;
  if (current.methodology==='bradley') {
    result = scoreBradley(current.answers);
  } else {
    result = scoreHeartsMinds(current.answers);
  }

  const record = {
    timestamp: nowISO(),
    company: current.meta.company,
    unit: current.meta.unit || '',
    assessor: current.meta.assessor || '',
    methodology: current.methodology,
    result
  };

  addRecord(record);
  toast('Avaliação salva no dispositivo.', 'ok');
  current = null;
  assessmentContainer.classList.add('hidden');
  renderHistory();
});

cancelBtn.addEventListener('click', ()=>{
  current = null;
  assessmentContainer.classList.add('hidden');
  toast('Avaliação cancelada.', 'info');
});

/* ==========================
   Histórico (tabela)
   ========================== */
function renderHistory() {
  const db = loadAll();
  // ordenar por timestamp ISO (mais recente primeiro)
  db.items.sort((a,b)=> (a.timestamp < b.timestamp ? 1 : -1));
  historyBody.innerHTML = '';

  if (db.items.length===0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="px-3 py-2 text-slate-500" colspan="7">Sem registros ainda.</td>`;
    historyBody.appendChild(tr);
    return;
  }

  db.items.forEach((r, idx)=>{
    const d = new Date(r.timestamp);
    const dateBR = d.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });
    const idxStr = (r.result.index!=null) ? `${r.result.index}` : '—';
    const lvlStr = r.result.level || '—';

    const tr = document.createElement('tr');
    tr.className = idx % 2 ? 'bg-white' : 'bg-slate-50';
    tr.innerHTML = `
      <td class="px-3 py-2">${dateBR}</td>
      <td class="px-3 py-2">${escapeCsvField(r.company)}</td>
      <td class="px-3 py-2">${escapeCsvField(r.unit || '')}</td>
      <td class="px-3 py-2">${r.methodology==='bradley' ? 'Bradley' : 'Hearts & Minds'}</td>
      <td class="px-3 py-2">${idxStr}</td>
      <td class="px-3 py-2">${lvlStr}</td>
      <td class="px-3 py-2">
        <button class="focus-ring text-blue-700 underline text-xs" data-act="view" data-i="${idx}">Ver</button>
        <button class="focus-ring text-rose-700 underline text-xs ml-2" data-act="del" data-i="${idx}">Excluir</button>
      </td>
    `;
    historyBody.appendChild(tr);
  });
}

historyBody.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]');
  if (!btn) return;
  const act = btn.getAttribute('data-act');
  const i = +btn.getAttribute('data-i');
  const db = loadAll();
  if (act==='view') {
    const r = db.items[i];
    const pretty = JSON.stringify(r, null, 2);
    console.log('Registro:', r);
    toast('Registro impresso no console para inspeção técnica.', 'info');
  } else if (act==='del') {
    db.items.splice(i,1);
    saveAll(db);
    renderHistory();
    toast('Registro excluído.', 'ok');
  }
});

/* ==========================
   Exportação CSV (BOM)
   ========================== */
function escapeCsvField(s) {
  const str = (s==null) ? '' : String(s);
  // Se contiver aspas, vírgula, quebra de linha: envolver em aspas e escapar aspas internas
  if (/[",\r\n;]/.test(str)) {
    return `"${str.replace(/"/g,'""')}"`;
  }
  return str;
}

function exportCSV() {
  const db = loadAll();
  const items = db.items || [];

  const sep = ','; // padronize aqui; pode trocar para ';' se preferir regional
  const header = [
    'timestampISO','dataLocal','empresa','unidade','assessor','metodologia','indice','nivel'
  ];

  const rows = [header.join(sep)];
  items.forEach(r=>{
    const dt = new Date(r.timestamp);
    const dataLocal = dt.toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });
    const idx = (r.result.index!=null) ? r.result.index : '';
    const lvl = r.result.level || '';
    const line = [
      escapeCsvField(r.timestamp),
      escapeCsvField(dataLocal),
      escapeCsvField(r.company),
      escapeCsvField(r.unit||''),
      escapeCsvField(r.assessor||''),
      escapeCsvField(r.methodology==='bradley'?'Bradley':'Hearts & Minds'),
      escapeCsvField(idx),
      escapeCsvField(lvl),
    ].join(sep);
    rows.push(line);
  });

  const csv = rows.join('\r\n');
  // BOM UTF-8 para abrir correto no Excel
  const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const dateName = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `EHS_Culture_${dateName}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast('CSV exportado com sucesso.', 'ok');
}

/* ==========================
   Botões primários
   ========================== */
btnStartBrad.addEventListener('click', ()=> renderAssessment('bradley'));
btnStartHM.addEventListener('click', ()=> renderAssessment('hm'));
document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
document.getElementById('clearAllBtn').addEventListener('click', ()=>{
  clearAll();
  renderHistory();
  toast('Histórico limpo deste dispositivo.', 'ok');
});

/* Inicialização */
enableStartButtonsIfValid();
renderHistory();
</script>
</body>
</html>
